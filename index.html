<!DOCTYPE html>
<html>
<head>
    <title>Lookout Housing Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: #1a1a1a; color: white; overflow: hidden; }
        
        #map { 
            height: 90vh; 
            width: 100%; 
            background: #222; 
            user-select: none; 
            -webkit-user-select: none; 
            outline: none;
        }

        .controls { padding: 10px; background: #222; display: flex; justify-content: center; gap: 12px; align-items: center; border-bottom: 1px solid #444; flex-wrap: wrap;}
        
        .status-container {
            display: flex;
            flex-direction: column;
            border-left: 1px solid #444;
            padding-left: 15px;
            min-width: 1500px; /* Adjusted for layout stability */
            min-width: fit-content;
        }

        .counter { font-weight: bold; color: #d4af37; font-size: 0.9rem; }
        .timestamp { font-size: 0.65rem; color: #888; margin-top: 2px; }
        
        button { cursor: pointer; background: #444; color: white; border: none; padding: 6px 12px; font-weight: bold; border-radius: 4px; transition: 0.2s; font-size: 0.85rem;}
        button:hover { background: #555; }
        
        .btn-active { background: #d4af37 !important; color: black !important; }
        .btn-submit { background: #28a745; color: white; }
        .btn-reset { background: #c82333; color: white; }

        select { padding: 5px; border-radius: 4px; background: #333; color: white; border: 1px solid #555; }

        /* Welcome Modal Styles */
        #welcomeModal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .modal-content {
            background: #2c2c2c;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            text-align: center;
            border: 2px solid #d4af37;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        .modal-content h2 { color: #d4af37; margin-top: 0; }
        .instruction-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: left; margin: 20px 0; }
        .instruction-item { background: #3d3d3d; padding: 10px; border-radius: 6px; font-size: 0.9rem; }
        .instruction-item b { color: #d4af37; display: block; margin-bottom: 4px; }
    </style>
</head>
<body oncontextmenu="return false;">

    <!-- Welcome Pop-up -->
    <div id="welcomeModal">
        <div class="modal-content">
            <h2>Lookout Housing Map</h2>
            <p>Hello friends, use this map to coordinate where we want to room, relatively. If anyone has the more detailed floor plan files, send them to Jacob. Use computer pleaseüëç</p>
            
            <div class="instruction-grid">
                <div class="instruction-item">
                    <b>Left Click + Drag</b>
                    Paint cells red to mark where you want to live.
                </div>
                <div class="instruction-item">
                    <b>Right Click / Middle</b>
                    Drag the map around to move your view.
                </div>
                <div class="instruction-item">
                    <b>Group Heatmap</b>
                    Switch views to see where everyone else is planning to pick.
                </div>
                <div class="instruction-item">
                    <b>Submit</b>
                    Saves your picks to the cloud for the rest of your group.
                </div>
            </div>

            <button onclick="closeModal()" style="padding: 10px 40px; background: #d4af37; color: black; font-size: 1rem;">Got it!</button>
        </div>
    </div>

    <div class="controls">
        <select id="floorSelect" onchange="switchFloor(this.value)">
            <option value="Floor 1">Floor 1</option>
            <option value="Floor 2">Floor 2</option>
            <option value="Floor 3-6">Floor 3-6</option>
        </select>

        <button id="btn-me" class="btn-active" onclick="toggleView('individual')">My View</button>
        <button id="btn-group" onclick="toggleView('aggregate')">Group Heatmap</button>

        <button class="btn-reset" onclick="resetCurrentFloor()">Reset Floor</button>
        <button class="btn-submit" onclick="submitToCloud()">Submit My Picks</button>
        
        <div class="status-container">
            <div id="roommateCounter" class="counter">Submissions: 0</div>
            <div id="lastUpdated" class="timestamp">Syncing...</div>
        </div>
    </div>

    <div id="map"></div>

    <script>
        // --- 1. FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyCJMadnmplIo9C9qFsV4_8BI_RgYtKXEiA",
            authDomain: "housing-53f24.firebaseapp.com",
            databaseURL: "https://housing-53f24-default-rtdb.firebaseio.com",
            projectId: "housing-53f24",
            storageBucket: "housing-53f24.firebasestorage.app",
            messagingSenderId: "168437453675",
            appId: "1:168437453675:web:7ee3aa725d1bb7f86eb22e"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- 2. STATE ---
        var imgWidth = 2000, imgHeight = 1500; 
        var gridSize = 25; 
        var currentFloor = "Floor 1";
        var viewMode = "individual"; 
        var selections = { "Floor 1": [], "Floor 2": [], "Floor 3-6": [] };

        var floorPlans = {
            "Floor 1": "floor1.png",
            "Floor 2": "floor2.png",
            "Floor 3-6": "floor3.png"
        };

        // --- 3. MODAL LOGIC ---
        function closeModal() {
            document.getElementById('welcomeModal').style.display = 'none';
        }

        // --- 4. MAP INIT ---
        var map = L.map('map', { 
            crs: L.CRS.Simple, 
            minZoom: -1, 
            maxZoom: 3,
            boxZoom: false,
            doubleClickZoom: false,
            dragging: false,
            preferCanvas: true // Performance boost for many vectors
        });
        
        map.getContainer().onselectstart = function() { return false; };

        var southWest = map.unproject([0, imgHeight], map.getMaxZoom()-1);
        var northEast = map.unproject([imgWidth, 0], map.getMaxZoom()-1);
        var bounds = new L.LatLngBounds(southWest, northEast);
        var imgOverlay = L.imageOverlay(floorPlans[currentFloor], bounds).addTo(map);
        map.fitBounds(bounds);

        var tileLayers = L.layerGroup().addTo(map);
        var tileLookup = {}; 

        let isRightDragging = false;
        let lastPos = { x: 0, y: 0 };

        map.on('mousedown', function(e) {
            // Button 2 is right click, Button 1 is middle click
            if (e.originalEvent.button === 2 || e.originalEvent.button === 1) {
                isRightDragging = true;
                lastPos = { x: e.originalEvent.clientX, y: e.originalEvent.clientY };
            }
        });

        window.addEventListener('mousemove', function(e) {
            if (isRightDragging) {
                let dx = e.clientX - lastPos.x;
                let dy = e.clientY - lastPos.y;
                map.panBy([-dx, -dy], { animate: false });
                lastPos = { x: e.clientX, y: e.clientY };
            }
        }, { passive: true });

        window.addEventListener('mouseup', function() {
            isRightDragging = false;
        });

        // --- 5. GRID LOGIC ---
        function generateGrid() {
            tileLayers.clearLayers();
            for (var x = 0; x < imgWidth; x += gridSize) {
                for (var y = 0; y < imgHeight; y += gridSize) {
                    var id = x + "_" + y;
                    var p1 = map.unproject([x, y], map.getMaxZoom()-1);
                    var p2 = map.unproject([x + gridSize, y + gridSize], map.getMaxZoom()-1);
                    
                    var rect = L.rectangle([p1, p2], {
                        color: "rgba(51, 136, 255, 0.1)",
                        weight: 1,
                        fillOpacity: 0,
                        interactive: true,
                        bubblingMouseEvents: false // Prevent event bubbling for better performance
                    });
                    
                    rect.tileId = id;

                    rect.on('mousedown', function(e) {
                        if (e.originalEvent.button === 0) {
                            paintTile(this);
                        }
                    });

                    rect.on('mouseover', function(e) {
                        // Check if left button is pressed
                        if (e.originalEvent.buttons === 1) {
                            paintTile(this);
                        }
                    });

                    tileLookup[id] = rect;
                    rect.addTo(tileLayers);
                }
            }
        }

        function paintTile(tile) {
            if (viewMode !== "individual") return; 
            if (!selections[currentFloor].includes(tile.tileId)) {
                selections[currentFloor].push(tile.tileId);
                // Optimized style update
                tile.setStyle({ fillColor: '#ff0000', fillOpacity: 0.5, color: 'transparent' });
            }
        }

        function resetCurrentFloor() {
            if (confirm("Wipe your marks for " + currentFloor + "?")) {
                selections[currentFloor] = [];
                refreshTiles();
            }
        }

        function switchFloor(newFloor) {
            currentFloor = newFloor;
            imgOverlay.setUrl(floorPlans[newFloor]);
            if (viewMode === "individual") refreshTiles(); else fetchHeatmap();
        }

        function refreshTiles() {
            // Batch style updates can be faster than individual calls in some browsers
            Object.keys(tileLookup).forEach(id => {
                var tile = tileLookup[id];
                var isSelected = selections[currentFloor].includes(id);
                var style = isSelected ? 
                    { fillColor: '#ff0000', fillOpacity: 0.5, color: 'transparent' } : 
                    { fillColor: 'transparent', fillOpacity: 0, color: "rgba(51, 136, 255, 0.15)" };
                tile.setStyle(style);
            });
        }

        function toggleView(mode) {
            viewMode = mode;
            document.getElementById('btn-me').className = (mode === 'individual' ? 'btn-active' : '');
            document.getElementById('btn-group').className = (mode === 'aggregate' ? 'btn-active' : '');
            if (mode === "individual") refreshTiles(); else fetchHeatmap();
        }

        function getHeatColor(count, total) {
            if (count === 0) return 'transparent';
            var ratio = count / total;
            if (ratio <= 0.34) return "#28a745"; 
            if (ratio <= 0.67) return "#ffc107"; 
            return "#dc3545"; 
        }

        function fetchHeatmap() {
            db.ref('submissions').once('value', (snapshot) => {
                const data = snapshot.val();
                if (!data) return;
                const users = Object.keys(data);
                const total = users.length;

                Object.keys(tileLookup).forEach(id => {
                    let hitCount = 0;
                    users.forEach(u => {
                        if (data[u] && data[u][currentFloor] && data[u][currentFloor].includes(id)) hitCount++;
                    });
                    
                    var color = getHeatColor(hitCount, total);
                    tileLookup[id].setStyle({
                        fillColor: color,
                        fillOpacity: hitCount > 0 ? 0.7 : 0,
                        color: hitCount > 0 ? 'transparent' : "rgba(51, 136, 255, 0.1)"
                    });
                });
            });
        }

        function submitToCloud() {
            const name = prompt("Enter your name:");
            if (!name) return;
            db.ref('submissions/' + name).set(selections).then(() => {
                alert("Saved to cloud!");
            });
        }

        db.ref('submissions').on('value', (snap) => {
            const data = snap.val();
            const count = data ? Object.keys(data).length : 0;
            document.getElementById('roommateCounter').innerText = "Submissions: " + count;
            document.getElementById('lastUpdated').innerText = "Sync: " + new Date().toLocaleTimeString();
        });

        // --- ADMIN ---
        window.listUsers = function() {
            const pw = prompt("Admin Password:");
            if (pw !== "Mines2026") return console.error("Access Denied");
            db.ref('submissions').once('value', (snap) => {
                const data = snap.val();
                if (!data) return console.log("No users found.");
                console.log("%c--- REGISTERED USERS ---", "color: #d4af37; font-weight: bold;");
                Object.keys(data).forEach(name => console.log("- " + name));
                console.log("-------------------------");
                alert("Check the browser console (F12) for the list of names.");
            });
        };

        window.deleteUser = function(target) {
            const pw = prompt("Admin Password:");
            if (pw === "Mines2026") {
                db.ref('submissions/' + target).remove().then(() => {
                    alert("Deleted user: " + target);
                    location.reload();
                });
            }
        };

        generateGrid();
    </script>
</body>
</html>