<!DOCTYPE html>
<html>
<head>
    <title>Mines Housing Tactical Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #1a1a1a; color: white; overflow: hidden; }
        
        /* FIX: Prevents the blue selection box when Shift+Dragging */
        #map { 
            height: 90vh; 
            width: 100%; 
            background: #222; 
            user-select: none; 
            -webkit-user-select: none; 
        }

        .controls { padding: 10px; background: #222; display: flex; justify-content: center; gap: 15px; align-items: center; border-bottom: 1px solid #444; }
        .hint { font-size: 0.8rem; color: #aaa; }
        
        button { cursor: pointer; background: #444; color: white; border: none; padding: 8px 15px; font-weight: bold; border-radius: 4px; transition: 0.2s; }
        button:hover { background: #555; }
        
        /* Mines Gold for active buttons */
        .btn-active { background: #d4af37 !important; color: black !important; }
        .btn-submit { background: #28a745; color: white; margin-left: 20px; }
    </style>
</head>
<body>

    <div class="controls">
        <select id="floorSelect" onchange="switchFloor(this.value)">
            <option value="Floor 1">Floor 1</option>
            <option value="Floor 2">Floor 2</option>
            <option value="Floor 3">Floor 3</option>
        </select>

        <div style="border-left: 1px solid #444; height: 20px; margin: 0 10px;"></div>

        <button id="btn-me" class="btn-active" onclick="toggleView('individual')">My View</button>
        <button id="btn-group" onclick="toggleView('aggregate')">Group Heatmap</button>

        <div class="hint"><b>Drag:</b> Move | <b>Shift+Drag:</b> Paint</div>

        <button class="btn-submit" onclick="submitToCloud()">Submit My Picks</button>
    </div>

    <div id="map"></div>

    <script>
        // --- 1. FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyCJMadnmplIo9C9qFsV4_8BI_RgYtKXEiA",
            authDomain: "housing-53f24.firebaseapp.com",
            databaseURL: "https://housing-53f24-default-rtdb.firebaseio.com",
            projectId: "housing-53f24",
            storageBucket: "housing-53f24.firebasestorage.app",
            messagingSenderId: "168437453675",
            appId: "1:168437453675:web:7ee3aa725d1bb7f86eb22e"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- 2. STATE & CONFIG ---
        var imgWidth = 2000, imgHeight = 1500; // ADJUST THESE TO YOUR IMAGE PIXELS
        var gridSize = 25; 
        var currentFloor = "Floor 1";
        var viewMode = "individual"; 
        var selections = { "Floor 1": [], "Floor 2": [], "Floor 3": [] };

        var floorPlans = {
            "Floor 1": "floor1.png",
            "Floor 2": "floor2.png",
            "Floor 3": "floor3.png"
        };

        // --- 3. MAP INIT ---
        var map = L.map('map', { crs: L.CRS.Simple, minZoom: -1, maxZoom: 3 });
        var southWest = map.unproject([0, imgHeight], map.getMaxZoom()-1);
        var northEast = map.unproject([imgWidth, 0], map.getMaxZoom()-1);
        var bounds = new L.LatLngBounds(southWest, northEast);
        var imgOverlay = L.imageOverlay(floorPlans[currentFloor], bounds).addTo(map);
        map.fitBounds(bounds);

        var tileLayers = L.layerGroup().addTo(map);
        var tileLookup = {}; 

        // --- 4. GRID LOGIC ---
        function generateGrid() {
            tileLayers.clearLayers();
            for (var x = 0; x < imgWidth; x += gridSize) {
                for (var y = 0; y < imgHeight; y += gridSize) {
                    var id = x + "_" + y;
                    var p1 = map.unproject([x, y], map.getMaxZoom()-1);
                    var p2 = map.unproject([x + gridSize, y + gridSize], map.getMaxZoom()-1);
                    
                    var rect = L.rectangle([p1, p2], {
                        color: "rgba(51, 136, 255, 0.1)",
                        weight: 1,
                        fillOpacity: 0,
                        interactive: true
                    });
                    
                    rect.tileId = id;

                    // FIX: Prevent selection box on mousedown
                    rect.on('mousedown', function(e) {
                        if (e.originalEvent.shiftKey) {
                            e.originalEvent.preventDefault(); 
                            paintTile(this);
                        }
                    });

                    rect.on('mouseover', function(e) {
                        if (e.originalEvent.shiftKey && (e.originalEvent.buttons === 1)) {
                            paintTile(this);
                        }
                    });

                    tileLookup[id] = rect;
                    rect.addTo(tileLayers);
                }
            }
        }

        function paintTile(tile) {
            if (viewMode !== "individual") return; // Can't paint while in Group View
            if (!selections[currentFloor].includes(tile.tileId)) {
                selections[currentFloor].push(tile.tileId);
                tile.setStyle({ fillColor: '#ff0000', fillOpacity: 0.5, color: 'transparent' });
            }
        }

        function switchFloor(newFloor) {
            currentFloor = newFloor;
            imgOverlay.setUrl(floorPlans[newFloor]);
            if (viewMode === "individual") refreshTiles(); else fetchHeatmap();
        }

        function refreshTiles() {
            Object.keys(tileLookup).forEach(id => {
                var tile = tileLookup[id];
                var isSelected = selections[currentFloor].includes(id);
                tile.setStyle({ 
                    fillColor: isSelected ? '#ff0000' : 'transparent', 
                    fillOpacity: isSelected ? 0.5 : 0,
                    color: "rgba(51, 136, 255, 0.15)"
                });
            });
        }

        function toggleView(mode) {
            viewMode = mode;
            document.getElementById('btn-me').className = (mode === 'individual' ? 'btn-active' : '');
            document.getElementById('btn-group').className = (mode === 'aggregate' ? 'btn-active' : '');
            if (mode === "individual") refreshTiles(); else fetchHeatmap();
        }

        // --- 5. HEATMAP COLOR LOGIC ---
        function getHeatColor(count, total) {
            if (count === 0) return 'transparent';
            var ratio = count / total;
            if (ratio <= 0.34) return "#00ff00"; // Green
            if (ratio <= 0.67) return "#ffff00"; // Yellow
            return "#ff0000"; // Red
        }

        function fetchHeatmap() {
            db.ref('submissions').once('value', (snapshot) => {
                const data = snapshot.val();
                if (!data) return;
                const users = Object.keys(data);
                const total = users.length;

                Object.keys(tileLookup).forEach(id => {
                    let hitCount = 0;
                    users.forEach(u => {
                        if (data[u][currentFloor] && data[u][currentFloor].includes(id)) hitCount++;
                    });
                    
                    var color = getHeatColor(hitCount, total);
                    tileLookup[id].setStyle({
                        fillColor: color,
                        fillOpacity: hitCount > 0 ? 0.6 : 0,
                        color: hitCount > 0 ? 'transparent' : "rgba(51, 136, 255, 0.1)"
                    });
                });
            });
        }

        // --- 6. ADMIN & SUBMISSION ---
        function submitToCloud() {
            const name = prompt("Enter your name:");
            if (!name) return;
            
            db.ref('submissions/' + name).once('value', (snap) => {
                if (snap.exists()) {
                    if (!confirm("Overwrite your existing picks?")) return;
                }
                db.ref('submissions/' + name).set(selections).then(() => alert("Saved!"));
            });
        }

        // Run this in console to clear a user: deleteUser('Name')
        function deleteUser(target) {
            const pw = prompt("Admin Pass:");
            if (pw === "Mines2026") {
                db.ref('submissions/' + target).remove().then(() => location.reload());
            }
        }

        generateGrid();
    </script>
</body>
</html>