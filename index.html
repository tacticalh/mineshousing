<!DOCTYPE html>
<html>
<head>
    <title>Mines Housing Heatmap</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #1a1a1a; color: white; overflow: hidden; }
        #map { height: 90vh; width: 100%; background: #222; cursor: crosshair; }
        .controls { padding: 10px; background: #222; display: flex; justify-content: center; gap: 20px; align-items: center; border-bottom: 1px solid #444; }
        select, button { padding: 8px; border-radius: 4px; border: none; background: #444; color: white; cursor: pointer; }
        .hint { font-size: 0.8rem; color: #aaa; }
    </style>
</head>
<body>

    <div class="controls">
        <h1>Mines Housing Map</h1>
        <select id="floorSelect" onchange="changeFloor(this.value)">
            <option value="Floor 1">Floor 1</option>
            <option value="Floor 2">Floor 2</option>
            <option value="Floor 3">Floor 3</option>
        </select>
        <div class="hint"><b>Left-Click + Drag:</b> Paint | <b>Shift + Drag:</b> Move Map | <b>Scroll:</b> Zoom</div>
        <button onclick="exportData()">Export Selection</button>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // 1. CONFIGURATION
        var imgWidth = 2000;
        var imgHeight = 1500;
        var gridSize = 25; // Higher resolution (smaller tiles)
        var isPanning = false;

        var floorPlans = {
            "Floor 1": "floor1.png",
            "Floor 2": "floor2.png",
            "Floor 3": "floor3.png"
        };

        // 2. SETUP MAP
        var map = L.map('map', {
            crs: L.CRS.Simple,
            minZoom: -1,
            maxZoom: 3,
            dragging: false, // Disable default dragging to allow "Paint Mode"
            scrollWheelZoom: true
        });

        var southWest = map.unproject([0, imgHeight], map.getMaxZoom()-1);
        var northEast = map.unproject([imgWidth, 0], map.getMaxZoom()-1);
        var bounds = new L.LatLngBounds(southWest, northEast);

        var currentImageLayer = L.imageOverlay(floorPlans["Floor 1"], bounds).addTo(map);
        map.fitBounds(bounds);

        // 3. TOGGLE DRAGGING (Shift Key Logic)
        document.addEventListener('keydown', (e) => { if(e.key === "Shift") map.dragging.enable(); });
        document.addEventListener('keyup', (e) => { if(e.key === "Shift") map.dragging.disable(); });
        
        // Middle Mouse Dragging
        map.on('mousedown', (e) => {
            if (e.originalEvent.button === 1) { // Middle mouse
                map.dragging.enable();
            }
        });
        map.on('mouseup', (e) => {
            if (e.originalEvent.button === 1) {
                map.dragging.disable();
            }
        });

        // 4. PAINTING LOGIC
        var isDrawing = false;
        var tileLayer = L.layerGroup().addTo(map);

        function changeFloor(floorName) {
            currentImageLayer.setUrl(floorPlans[floorName]);
        }

        // Generate Tiles
        for (var x = 0; x < imgWidth; x += gridSize) {
            for (var y = 0; y < imgHeight; y += gridSize) {
                var p1 = map.unproject([x, y], map.getMaxZoom()-1);
                var p2 = map.unproject([x + gridSize, y + gridSize], map.getMaxZoom()-1);
                
                var rect = L.rectangle([p1, p2], {
                    color: "rgba(51, 136, 255, 0.2)", // Faint blue lines
                    weight: 1,
                    fillOpacity: 0,
                    interactive: true,
                    className: 'tile' 
                });

                // Paint on MouseOver if mouse is down
                rect.on('mousedown', function(e) { 
                    if(!map.dragging.enabled()) {
                        isDrawing = true;
                        paintTile(e.target);
                    }
                });
                
                rect.on('mouseover', function(e) {
                    if (isDrawing && !map.dragging.enabled()) {
                        paintTile(e.target);
                    }
                });

                rect.addTo(tileLayer);
            }
        }

        window.addEventListener('mouseup', () => { isDrawing = false; });

        function paintTile(tile) {
            tile.setStyle({
                fillColor: '#ff0000',
                fillOpacity: 0.5,
                color: 'transparent'
            });
            tile.isHighPriority = true; // Custom property for exporting
        }

        // 5. DATA EXPORT (For the "Submission" step)
        function exportData() {
            var selectedTiles = [];
            tileLayer.eachLayer(function(layer) {
                if (layer.isHighPriority) {
                    selectedTiles.push(layer.getBounds());
                }
            });
            console.log("Selected Tiles:", selectedTiles);
            alert("Check console for tile data! You have selected " + selectedTiles.length + " tiles.");
        }
    </script>
</body>
</html>