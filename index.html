<!DOCTYPE html>
<html>
<head>
    <title>Mines Housing Tactical Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: #1a1a1a; color: white; overflow: hidden; }
        
        /* Box Zoom Disabled via JS, Selection disabled via CSS */
        #map { 
            height: 90vh; 
            width: 100%; 
            background: #222; 
            user-select: none; 
            -webkit-user-select: none; 
        }

        .controls { padding: 10px; background: #222; display: flex; justify-content: center; gap: 12px; align-items: center; border-bottom: 1px solid #444; flex-wrap: wrap;}
        .hint { font-size: 0.75rem; color: #aaa; }
        
        .status-container {
            display: flex;
            flex-direction: column;
            border-left: 1px solid #444;
            padding-left: 15px;
            min-width: 150px;
        }

        .counter { font-weight: bold; color: #d4af37; font-size: 0.9rem; }
        .timestamp { font-size: 0.65rem; color: #888; margin-top: 2px; }
        
        button { cursor: pointer; background: #444; color: white; border: none; padding: 6px 12px; font-weight: bold; border-radius: 4px; transition: 0.2s; font-size: 0.85rem;}
        button:hover { background: #555; }
        
        .btn-active { background: #d4af37 !important; color: black !important; }
        .btn-submit { background: #28a745; color: white; }
        .btn-reset { background: #c82333; color: white; }

        select { padding: 5px; border-radius: 4px; background: #333; color: white; border: 1px solid #555; }
    </style>
</head>
<body oncontextmenu="return false;">

    <div class="controls">
        <select id="floorSelect" onchange="switchFloor(this.value)">
            <option value="Floor 1">Floor 1</option>
            <option value="Floor 2">Floor 2</option>
            <option value="Floor 3">Floor 3</option>
        </select>

        <button id="btn-me" class="btn-active" onclick="toggleView('individual')">My View</button>
        <button id="btn-group" onclick="toggleView('aggregate')">Group Heatmap</button>

        <div class="hint"><b>Shift+Drag</b> to Paint</div>

        <button class="btn-reset" onclick="resetCurrentFloor()">Reset Floor</button>
        <button class="btn-submit" onclick="submitToCloud()">Submit My Picks</button>
        
        <div class="status-container">
            <div id="roommateCounter" class="counter">Submissions: 0</div>
            <div id="lastUpdated" class="timestamp">Syncing...</div>
        </div>
    </div>

    <div id="map"></div>

    <script>
        // --- 1. FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyCJMadnmplIo9C9qFsV4_8BI_RgYtKXEiA",
            authDomain: "housing-53f24.firebaseapp.com",
            databaseURL: "https://housing-53f24-default-rtdb.firebaseio.com",
            projectId: "housing-53f24",
            storageBucket: "housing-53f24.firebasestorage.app",
            messagingSenderId: "168437453675",
            appId: "1:168437453675:web:7ee3aa725d1bb7f86eb22e"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- 2. STATE ---
        var imgWidth = 2000, imgHeight = 1500; 
        var gridSize = 25; 
        var currentFloor = "Floor 1";
        var viewMode = "individual"; 
        var selections = { "Floor 1": [], "Floor 2": [], "Floor 3": [] };

        var floorPlans = {
            "Floor 1": "floor1.png",
            "Floor 2": "floor2.png",
            "Floor 3": "floor3.png"
        };

        // --- 3. MAP INIT ---
        var map = L.map('map', { 
            crs: L.CRS.Simple, 
            minZoom: -1, 
            maxZoom: 3,
            boxZoom: false,      // REMOVES THE VIEW BOX
            doubleClickZoom: false
        });
        
        // Block text selection on the map
        map.getContainer().onselectstart = function() { return false; };

        var southWest = map.unproject([0, imgHeight], map.getMaxZoom()-1);
        var northEast = map.unproject([imgWidth, 0], map.getMaxZoom()-1);
        var bounds = new L.LatLngBounds(southWest, northEast);
        var imgOverlay = L.imageOverlay(floorPlans[currentFloor], bounds).addTo(map);
        map.fitBounds(bounds);

        var tileLayers = L.layerGroup().addTo(map);
        var tileLookup = {}; 

        // --- 4. GRID LOGIC ---
        function generateGrid() {
            tileLayers.clearLayers();
            for (var x = 0; x < imgWidth; x += gridSize) {
                for (var y = 0; y < imgHeight; y += gridSize) {
                    var id = x + "_" + y;
                    var p1 = map.unproject([x, y], map.getMaxZoom()-1);
                    var p2 = map.unproject([x + gridSize, y + gridSize], map.getMaxZoom()-1);
                    
                    var rect = L.rectangle([p1, p2], {
                        color: "rgba(51, 136, 255, 0.1)",
                        weight: 1,
                        fillOpacity: 0,
                        interactive: true
                    });
                    
                    rect.tileId = id;

                    rect.on('mousedown', function(e) {
                        if (e.originalEvent.shiftKey) {
                            L.DomEvent.stop(e); 
                            paintTile(this);
                        }
                    });

                    rect.on('mouseover', function(e) {
                        if (e.originalEvent.shiftKey && (e.originalEvent.buttons === 1)) {
                            paintTile(this);
                        }
                    });

                    tileLookup[id] = rect;
                    rect.addTo(tileLayers);
                }
            }
        }

        function paintTile(tile) {
            if (viewMode !== "individual") return; 
            if (!selections[currentFloor].includes(tile.tileId)) {
                selections[currentFloor].push(tile.tileId);
                tile.setStyle({ fillColor: '#ff0000', fillOpacity: 0.5, color: 'transparent' });
            }
        }

        function resetCurrentFloor() {
            if (confirm("Wipe your marks for " + currentFloor + "?")) {
                selections[currentFloor] = [];
                refreshTiles();
            }
        }

        function switchFloor(newFloor) {
            currentFloor = newFloor;
            imgOverlay.setUrl(floorPlans[newFloor]);
            if (viewMode === "individual") refreshTiles(); else fetchHeatmap();
        }

        function refreshTiles() {
            Object.keys(tileLookup).forEach(id => {
                var tile = tileLookup[id];
                var isSelected = selections[currentFloor].includes(id);
                tile.setStyle({ 
                    fillColor: isSelected ? '#ff0000' : 'transparent', 
                    fillOpacity: isSelected ? 0.5 : 0,
                    color: "rgba(51, 136, 255, 0.15)"
                });
            });
        }

        function toggleView(mode) {
            viewMode = mode;
            document.getElementById('btn-me').className = (mode === 'individual' ? 'btn-active' : '');
            document.getElementById('btn-group').className = (mode === 'aggregate' ? 'btn-active' : '');
            if (mode === "individual") refreshTiles(); else fetchHeatmap();
        }

        function getHeatColor(count, total) {
            if (count === 0) return 'transparent';
            var ratio = count / total;
            if (ratio <= 0.34) return "#28a745"; // Green
            if (ratio <= 0.67) return "#ffc107"; // Yellow
            return "#dc3545"; // Red
        }

        function fetchHeatmap() {
            db.ref('submissions').once('value', (snapshot) => {
                const data = snapshot.val();
                if (!data) return;
                const users = Object.keys(data);
                const total = users.length;

                Object.keys(tileLookup).forEach(id => {
                    let hitCount = 0;
                    users.forEach(u => {
                        if (data[u] && data[u][currentFloor] && data[u][currentFloor].includes(id)) hitCount++;
                    });
                    
                    var color = getHeatColor(hitCount, total);
                    tileLookup[id].setStyle({
                        fillColor: color,
                        fillOpacity: hitCount > 0 ? 0.7 : 0,
                        color: hitCount > 0 ? 'transparent' : "rgba(51, 136, 255, 0.1)"
                    });
                });
            });
        }

        // --- 5. CLOUD INTERACTION ---
        function submitToCloud() {
            const name = prompt("Enter your name:");
            if (!name) return;
            
            db.ref('submissions/' + name).set(selections).then(() => {
                alert("Saved to cloud!");
            });
        }

        // Listen for data changes to update counter and timestamp
        db.ref('submissions').on('value', (snap) => {
            const data = snap.val();
            const count = data ? Object.keys(data).length : 0;
            document.getElementById('roommateCounter').innerText = "Submissions: " + count;
            document.getElementById('lastUpdated').innerText = "Sync: " + new Date().toLocaleTimeString();
        });

        // --- 6. ADMIN COMMANDS (Console Only) ---

        // List all users: listUsers()
        window.listUsers = function() {
            const pw = prompt("Admin Password:");
            if (pw !== "Mines2026") return console.error("Access Denied");
            
            db.ref('submissions').once('value', (snap) => {
                const data = snap.val();
                if (!data) return console.log("No users found.");
                console.log("%c--- REGISTERED USERS ---", "color: #d4af37; font-weight: bold;");
                Object.keys(data).forEach(name => console.log("- " + name));
                console.log("-------------------------");
                alert("Check the browser console (F12) for the list of names.");
            });
        };

        // Delete a user: deleteUser("name")
        window.deleteUser = function(target) {
            const pw = prompt("Admin Password:");
            if (pw === "Mines2026") {
                db.ref('submissions/' + target).remove().then(() => {
                    alert("Deleted user: " + target);
                    location.reload();
                });
            } else {
                alert("Access Denied.");
            }
        };

        generateGrid();
    </script>
</body>
</html>